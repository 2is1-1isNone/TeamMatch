{% extends "users/base.html" %}
{% load django_bootstrap5 %}

{% block title %}Create New Team{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="container-fluid mb-3" style="background-color: white; border-bottom: 1px solid #dee2e6; padding: 15px 0;">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{% url 'home' %}" class="text-decoration-none">
                    <i class="fas fa-home"></i> Home
                </a>
            </li>
            {% if user.is_superuser %}
            <li class="breadcrumb-item">
                <a href="{% url 'control_plane' %}" class="text-decoration-none">
                    <i class="fas fa-cogs"></i> Control Plane
                </a>
            </li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fas fa-users"></i> Create Team
            </li>
        </ol>
    </nav>
</div>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Create New Team</h2>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="card">
        <div class="card-body">
            <form method="post" id="create-team-form">
                {% csrf_token %}
                
                <!-- Step 1: Team Name -->
                <div class="mb-4">
                    <h5><i class="fas fa-users text-primary"></i> Team Information</h5>
                    <hr>
                    
                    <div class="mb-3">
                        <label for="team_name" class="form-label"><strong>Team Name *</strong></label>
                        <input type="text" id="team_name" name="team_name" class="form-control" 
                               placeholder="Enter team name" required>
                        <div class="form-text">Choose a descriptive name for your team</div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <label for="age_group" class="form-label"><strong>Age Group *</strong></label>
                            <select id="age_group" name="age_group" class="form-select" required>
                                <option value="">Select Age Group</option>
                                {% for value, label in age_groups %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="tier" class="form-label"><strong>Tier *</strong></label>
                            <select id="tier" name="tier" class="form-select" required>
                                <option value="">Select Tier</option>
                                {% for value, label in tiers %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="season" class="form-label"><strong>Season</strong></label>
                            <input type="text" id="season" name="season" class="form-control" 
                                   placeholder="e.g., Fall 2024">
                        </div>
                    </div>
                </div>

                <!-- Step 2: Club Selection -->
                <div class="mb-4">
                    <h5><i class="fas fa-building text-primary"></i> Club Selection</h5>
                    <hr>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Club Option *</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="club_choice" id="existing_club_option" 
                                   value="existing" checked onchange="toggleClubOptions()">
                            <label class="form-check-label" for="existing_club_option">
                                Choose from existing clubs
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="club_choice" id="new_club_option" 
                                   value="new" onchange="toggleClubOptions()">
                            <label class="form-check-label" for="new_club_option">
                                Create a new club
                            </label>
                        </div>
                    </div>

                    <!-- Existing Club Selection -->
                    <div id="existing-club-section" class="mb-3">
                        <label for="existing_club" class="form-label"><strong>Select Club *</strong></label>
                        <select id="existing_club" name="existing_club" class="form-select" onchange="updateAssociationFromClub()">
                            <option value="">Choose a club...</option>
                            {% for club in clubs %}
                                <option value="{{ club.id }}" data-association="{{ club.association.id }}" 
                                        data-association-name="{{ club.association.name }}">
                                    {{ club.name }} ({{ club.association.name }})
                                </option>
                            {% endfor %}
                        </select>
                        <div id="selected-association-display" class="form-text mt-2" style="display: none;">
                            <strong>Association:</strong> <span id="association-name-display"></span>
                        </div>
                    </div>

                    <!-- New Club Section -->
                    <div id="new-club-section" style="display: none;">
                        <div class="mb-3">
                            <label for="new_club_name" class="form-label"><strong>New Club Name *</strong></label>
                            <input type="text" id="new_club_name" name="new_club_name" class="form-control" 
                                   placeholder="Enter club name">
                        </div>

                        <div class="mb-3">
                            <label for="new_club_location" class="form-label"><strong>Club Location</strong></label>
                            <input type="text" id="new_club_location" name="new_club_location" class="form-control" 
                                   placeholder="e.g., Seattle, WA or Kraken Community Iceplex">
                            <div class="form-text">Club's primary location (city, rink, or address)</div>
                        </div>

                        <!-- Association for New Club -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Association *</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="association_choice" 
                                       id="existing_association_option" value="existing" checked onchange="toggleAssociationOptions()">
                                <label class="form-check-label" for="existing_association_option">
                                    Choose from existing associations
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="association_choice" 
                                       id="new_association_option" value="new" onchange="toggleAssociationOptions()">
                                <label class="form-check-label" for="new_association_option">
                                    Create a new association
                                </label>
                            </div>
                        </div>

                        <div id="existing-association-section" class="mb-3">
                            <label for="existing_association" class="form-label"><strong>Select Association *</strong></label>
                            <select id="existing_association" name="existing_association" class="form-select">
                                <option value="">Choose an association...</option>
                                {% for association in associations %}
                                    <option value="{{ association.id }}">{{ association.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="new-association-section" style="display: none;">
                            <label for="new_association_name" class="form-label"><strong>New Association Name *</strong></label>
                            <input type="text" id="new_association_name" name="new_association_name" class="form-control" 
                                   placeholder="Enter association name">
                        </div>
                    </div>
                </div>

                <!-- Step 3: Additional Details -->
                <div class="mb-4">
                    <h5><i class="fas fa-info-circle text-primary"></i> Additional Details</h5>
                    <hr>
                    
                    <div class="mb-3">
                        <label for="location" class="form-label"><strong>Location</strong></label>
                        <input type="text" id="location" name="location" class="form-control" 
                               placeholder="City, State">
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label"><strong>Description</strong></label>
                        <textarea id="description" name="description" class="form-control" rows="3" 
                                  placeholder="Brief description of the team"></textarea>
                    </div>
                </div>

                <!-- Step 4: Team Invitations -->
                <div class="mb-4">
                    <h5><i class="fas fa-envelope text-primary"></i> Invite Team Members</h5>
                    <hr>
                    
                    <div class="mb-3">
                        <label for="invite_emails" class="form-label"><strong>Invite Members (Optional)</strong></label>
                        <input type="text" id="invite_emails" name="invite_emails" class="form-control" 
                               placeholder="user1@email.com, user2@email.com">
                        <div class="form-text">Enter comma-separated email addresses to invite members to this team</div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Team
                    </button>
                    <a href="{% url 'home' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleClubOptions() {
    const existingOption = document.getElementById('existing_club_option');
    const existingSection = document.getElementById('existing-club-section');
    const newSection = document.getElementById('new-club-section');
    
    if (existingOption.checked) {
        existingSection.style.display = 'block';
        newSection.style.display = 'none';
        // Clear new club fields
        document.getElementById('new_club_name').value = '';
        document.getElementById('new_association_name').value = '';
        document.getElementById('existing_association').value = '';
    } else {
        existingSection.style.display = 'none';
        newSection.style.display = 'block';
        // Clear existing club selection
        document.getElementById('existing_club').value = '';
        document.getElementById('selected-association-display').style.display = 'none';
    }
}

function toggleAssociationOptions() {
    const existingOption = document.getElementById('existing_association_option');
    const existingSection = document.getElementById('existing-association-section');
    const newSection = document.getElementById('new-association-section');
    
    if (existingOption.checked) {
        existingSection.style.display = 'block';
        newSection.style.display = 'none';
        document.getElementById('new_association_name').value = '';
    } else {
        existingSection.style.display = 'none';
        newSection.style.display = 'block';
        document.getElementById('existing_association').value = '';
    }
}

function updateAssociationFromClub() {
    const clubSelect = document.getElementById('existing_club');
    const selectedOption = clubSelect.options[clubSelect.selectedIndex];
    const display = document.getElementById('selected-association-display');
    const nameDisplay = document.getElementById('association-name-display');
    
    if (selectedOption.value) {
        const associationName = selectedOption.getAttribute('data-association-name');
        nameDisplay.textContent = associationName;
        display.style.display = 'block';
    } else {
        display.style.display = 'none';
    }
}

// Form validation
document.getElementById('create-team-form').addEventListener('submit', function(e) {
    const clubChoice = document.querySelector('input[name="club_choice"]:checked').value;
    
    if (clubChoice === 'existing') {
        if (!document.getElementById('existing_club').value) {
            e.preventDefault();
            alert('Please select a club.');
            return;
        }
    } else {
        if (!document.getElementById('new_club_name').value) {
            e.preventDefault();
            alert('Please enter a club name.');
            return;
        }
        
        const associationChoice = document.querySelector('input[name="association_choice"]:checked').value;
        if (associationChoice === 'existing') {
            if (!document.getElementById('existing_association').value) {
                e.preventDefault();
                alert('Please select an association.');
                return;
            }
        } else {
            if (!document.getElementById('new_association_name').value) {
                e.preventDefault();
                alert('Please enter an association name.');
                return;
            }
        }
    }
});
</script>
{% endblock %}
