{% extends "users/base.html" %}
{% block title %}{{ team.name }} Calendar{% endblock %}
{% block content %}
{% csrf_token %}

<!-- Breadcrumb Navigation -->
<div class="container-fluid mb-3" style="background-color: white; border-bottom: 1px solid #dee2e6; padding: 15px 0;">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{% url 'home' %}" class="text-decoration-none">
                    <i class="fas fa-home"></i> Home
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fas fa-calendar-alt"></i> {{ team.name }} Calendar
            </li>
        </ol>
    </nav>
</div>

<div class="container-fluid"

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- Availability Notification Area -->
<div id="availability-notifications" class="alert-container mb-4">
    <!-- Dynamic notifications will be inserted here -->
</div>

<!-- Deadline Banner -->
{% if availability_deadline %}
<div class="alert alert-info mb-4" role="alert">
    <strong>ðŸ“… Scheduling Deadline:</strong> Enter in as many home and away dates as you can so the scheduler has the best chance of finding matches. Your deadline for getting dates in is <strong>{{ availability_deadline|date:"m/d/Y" }} at {{ availability_deadline|time:"H:i:s" }}</strong>
</div>
{% endif %}

<div class="mb-4 d-flex align-items-center">
    <span id="homeLabel" class="fw-bold me-2" style="color:#87CEFA; cursor:pointer;">Home</span>
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="homeAwayToggle">
    </div>
    <span id="awayLabel" class="fw-bold ms-2" style="color:#ffb366; cursor:pointer;">Away</span>
</div>

<!-- Change this div -->
<div class="btn-group mb-3 d-flex justify-content-center" style="width: 33%; margin: 0 auto;">
    <button id="calendarViewBtn" class="btn btn-primary active btn-sm">Calendar View</button>
    <button id="tableViewBtn" class="btn btn-primary btn-sm">Table View</button>
</div>

<!-- Add table view (initially hidden) -->
<div id="tableView" class="table-responsive" style="display: none;">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Home/Away</th>
                <th>Allow Doubleheader</th>
            </tr>
        </thead>
        <tbody id="dateTableBody">
        </tbody>
    </table>
</div>

<!-- Existing calendar div -->
<div id="calendar"></div>

<script>
let mode = 'home';
let events = JSON.parse('{{ team_dates_json|escapejs }}') || [];
// Update event colors to use light blue for home and light orange for away
events = events.map(ev => ({
    ...ev,
    color: ev.title === 'Home Game' ? '#87CEFA' : '#ffb366',
    allow_doubleheader: ev.allow_doubleheader || false
}));

// Availability tracking variables from server
const totalTeams = parseInt('{{ total_teams|default:0 }}') || 0;
const requiredSeries = parseInt('{{ required_series|default:0 }}') || 0;

// Function to count weekend series (matching the Python logic)
function countWeekendSeries(dates) {
    if (dates.length < 2) return 0;
    
    const sortedDates = dates.sort((a, b) => new Date(a) - new Date(b));
    let seriesCount = 0;
    let i = 0;
    
    while (i < sortedDates.length - 1) {
        const currentDate = new Date(sortedDates[i]);
        const nextDate = new Date(sortedDates[i + 1]);
        const diffInDays = (nextDate - currentDate) / (1000 * 60 * 60 * 24);
        
        if (diffInDays === 1) {
            seriesCount++;
            i += 2; // Skip the next date since it's part of this series
        } else {
            i++;
        }
    }
    
    return seriesCount;
}

// Function to update availability notifications
function updateAvailabilityNotifications() {
    const notificationContainer = document.getElementById('availability-notifications');
    
    if (totalTeams <= 1) {
        notificationContainer.innerHTML = '';
        return;
    }
    
    // Get current home and away dates
    const homeDates = events.filter(ev => ev.title === 'Home Game').map(ev => ev.start);
    const awayDates = events.filter(ev => ev.title === 'Away Game').map(ev => ev.start);
    
    // Count available series
    const availableHomeSeries = countWeekendSeries(homeDates);
    const availableAwaySeries = countWeekendSeries(awayDates);
    
    // Calculate shortfalls
    const homeSeriesNeeded = Math.max(0, requiredSeries - availableHomeSeries);
    const awaySeriesNeeded = Math.max(0, requiredSeries - availableAwaySeries);
    
    // Build notifications HTML
    let notificationsHTML = '';
    
    if (homeSeriesNeeded > 0) {
        notificationsHTML += `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Availability Needed:</strong> Your team needs ${homeSeriesNeeded} more home game weekend availability dates
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    }
    
    if (awaySeriesNeeded > 0) {
        notificationsHTML += `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Availability Needed:</strong> Your team needs ${awaySeriesNeeded} more away game weekend availability dates
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    }
    
    notificationContainer.innerHTML = notificationsHTML;
}

document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        headerToolbar: {
            left: '',           // Move title to left
            center: 'title',              // Empty center
            right: 'prev,next'       // Both arrows on right
        },
        initialView: 'multiMonth',
        views: {
            multiMonth: {
                duration: { months: 8 },     // Show 8 months total
                multiMonthMaxColumns: 2,     // 2 columns
                multiMonthRows: 4            // 4 rows
            }
        },
        dayMaxEvents: 0,
        showNonCurrentDates: false, // Hide days from adjacent months
        fixedWeekCount: false, // Only show as many weeks as needed for the month
        height: 'auto',
        selectable: true,
        eventDisplay: 'none',
        selectMirror: true,        dateClick: function(info) {
            const existingEventIndex = events.findIndex(ev => ev.start === info.dateStr);
            
            if (existingEventIndex !== -1) {
                // Remove existing event
                events.splice(existingEventIndex, 1);                info.dayEl.style.backgroundColor = '';
                info.dayEl.style.color = '';
                removeDoubleheaderIndicator(info.dayEl);
                // Delete from database
                saveToDatabase(info.dateStr, null, false);
                
                // Update availability notifications
                updateAvailabilityNotifications();
            } else {
                // Add new event
                const isHome = mode === 'home';
                events.push({
                    title: isHome ? 'Home Game' : 'Away Game',
                    start: info.dateStr,
                    allDay: true,
                    color: isHome ? '#87CEFA' : '#ffb366',
                    allow_doubleheader: false
                });
                info.dayEl.style.backgroundColor = isHome ? '#87CEFA' : '#ffb366';
                info.dayEl.style.color = '#000';
                // Save to database with allow_doubleheader false
                saveToDatabase(info.dateStr, isHome, false);
                
                // Update availability notifications
                updateAvailabilityNotifications();
            }
        },
        dayCellDidMount: function(arg) {
            // Apply colors to any existing events
            const event = events.find(ev => ev.start === arg.dateStr);
            if (event) {
                arg.el.style.backgroundColor = event.color;
                arg.el.style.color = '#000';  // Black text for contrast
                
                // Add doubleheader indicator if enabled
                if (event.allow_doubleheader) {
                    addDoubleheaderIndicator(arg.el);
                }
            }
        },
        datesSet: function() {
            // Reapply colors when view changes
            events.forEach(event => {
                const cell = document.querySelector(`.fc-daygrid-day[data-date="${event.start}"]`);
                if (cell) {
                    cell.style.backgroundColor = event.color;
                    cell.style.color = '#000';  // Changed to black text
                    
                    // Add doubleheader indicator if enabled
                    if (event.allow_doubleheader) {
                        addDoubleheaderIndicator(cell);
                    }
                }
            });
        }
    });
    
    const toggle = document.getElementById('homeAwayToggle');
    const homeLabel = document.getElementById('homeLabel');
    const awayLabel = document.getElementById('awayLabel');

    toggle.addEventListener('change', function() {
        if (this.checked) {
            mode = 'away';
            homeLabel.style.opacity = 0.5;
            awayLabel.style.opacity = 1;
        } else {
            mode = 'home';
            homeLabel.style.opacity = 1;
            awayLabel.style.opacity = 0.5;
        }
    });

    // Make labels clickable
    homeLabel.addEventListener('click', function() {
        toggle.checked = false;
        toggle.dispatchEvent(new Event('change'));
    });
    awayLabel.addEventListener('click', function() {
        toggle.checked = true;
        toggle.dispatchEvent(new Event('change'));
    });    // Set initial state
    homeLabel.style.opacity = 1;
    awayLabel.style.opacity = 0.5;

    // Function to add doubleheader indicator
    function addDoubleheaderIndicator(cellElement) {
        // Remove existing indicator if present
        const existingIndicator = cellElement.querySelector('.doubleheader-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }        // Create doubleheader indicator
        const indicator = document.createElement('div');
        indicator.className = 'doubleheader-indicator';
        indicator.innerHTML = 'DH'; // "DH" text to indicate doubleheader
        indicator.title = 'Allow for Double Header'; // Tooltip text
        indicator.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            line-height: 1;
            color: #333;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 3px;
            width: 20px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #666;
            font-weight: bold;
            font-family: Arial, sans-serif;
            z-index: 10;
            cursor: help;
        `;
        
        // Ensure the cell has relative positioning
        cellElement.style.position = 'relative';
        cellElement.appendChild(indicator);
    }    // Function to remove doubleheader indicator
    function removeDoubleheaderIndicator(cellElement) {
        const indicator = cellElement.querySelector('.doubleheader-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    // Add double-click handler for calendar cells to toggle doubleheader
    document.addEventListener('dblclick', function(e) {
        const calendarCell = e.target.closest('.fc-daygrid-day');
        if (calendarCell) {
            const dateStr = calendarCell.getAttribute('data-date');
            const event = events.find(ev => ev.start === dateStr);
            
            if (event) {
                // Toggle doubleheader setting
                event.allow_doubleheader = !event.allow_doubleheader;
                
                // Update visual indicator
                if (event.allow_doubleheader) {
                    addDoubleheaderIndicator(calendarCell);
                } else {
                    removeDoubleheaderIndicator(calendarCell);
                }
                
                // Save to database
                saveToDatabase(dateStr, event.title === 'Home Game', event.allow_doubleheader);
                
                // Update table view if visible
                if (tableView.style.display !== 'none') {
                    updateTableView();
                }
            }
        }
    });

    // Add this function before calendar.render()
    function saveToDatabase(dateStr, isHome, allowDoubleheader) {
        fetch(`/team/{{ team.id }}/save-dates/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                date: dateStr,
                is_home: isHome,
                allow_doubleheader: allowDoubleheader
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to save date');
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // View toggle functionality
    const calendarView = document.getElementById('calendar');
    const tableView = document.getElementById('tableView');
    const calendarViewBtn = document.getElementById('calendarViewBtn');
    const tableViewBtn = document.getElementById('tableViewBtn');

    function updateTableView() {
        const tableBody = document.getElementById('dateTableBody');
        tableBody.innerHTML = '';
        const sortedEvents = [...events].sort((a, b) => a.start.localeCompare(b.start));
        sortedEvents.forEach((event, idx) => {            const row = document.createElement('tr');
            const dateCell = document.createElement('td');
            const typeCell = document.createElement('td');
            const doubleheaderCell = document.createElement('td');
            
            // Parse date properly to avoid timezone issues
            const dateParts = event.start.split('-');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
            const day = parseInt(dateParts[2]);
            const date = new Date(year, month, day);
            
            const formattedDate = date.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            });
            dateCell.textContent = formattedDate;
            typeCell.textContent = event.title === 'Home Game' ? 'Home' : 'Away';
            typeCell.style.color = event.title === 'Home Game' ? '#87CEFA' : '#ffb366';
            // Doubleheader checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!event.allow_doubleheader;            checkbox.addEventListener('change', function() {
                event.allow_doubleheader = this.checked;
                saveToDatabase(event.start, event.title === 'Home Game', event.allow_doubleheader);
                
                // Update calendar view indicator
                const calendarCell = document.querySelector(`.fc-daygrid-day[data-date="${event.start}"]`);
                if (calendarCell) {
                    if (this.checked) {
                        addDoubleheaderIndicator(calendarCell);
                    } else {
                        removeDoubleheaderIndicator(calendarCell);
                    }
                }
            });
            doubleheaderCell.appendChild(checkbox);
            row.appendChild(dateCell);
            row.appendChild(typeCell);
            row.appendChild(doubleheaderCell);
            tableBody.appendChild(row);
        });
    }

    calendarViewBtn.addEventListener('click', () => {
        calendarView.style.display = 'block';
        tableView.style.display = 'none';
        calendarViewBtn.classList.add('active');
        tableViewBtn.classList.remove('active');
    });

    tableViewBtn.addEventListener('click', () => {
        calendarView.style.display = 'none';
        tableView.style.display = 'block';
        calendarViewBtn.classList.remove('active');
        tableViewBtn.classList.add('active');
        updateTableView();
    });    // Update table when events change
    const originalSaveToDatabase = saveToDatabase;
    saveToDatabase = function(dateStr, isHome, allowDoubleheader) {
        originalSaveToDatabase(dateStr, isHome, allowDoubleheader);
        if (tableView.style.display !== 'none') {
            updateTableView();
        }
    };    calendar.render();
    
    // Initialize availability notifications on page load
    updateAvailabilityNotifications();
});
</script>

<p class="mt-3 text-muted">
    Click "Home" or "Away" then click a date to add games. Click a colored cell to remove it.<br>
    <strong>DH Doubleheader Feature:</strong> Double-click a colored date to toggle allow doubleheader (shown with DH indicator). Use table view for easier management.
</p>
{% if user in team.admins.all %}
    <a href="{% url 'edit_team' team.id %}" class="btn btn-warning mb-3">Edit Team</a>
{% endif %}

</div>
{% endblock %}